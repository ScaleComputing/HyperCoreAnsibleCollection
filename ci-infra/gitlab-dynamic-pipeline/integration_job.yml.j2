{{ ci_job_name }}:
  stage: test
  image: python:3.8.12-slim-buster
  # we have a single HC3 cluster, so run at most one "ansible-test integration some-test" at a time.
  resource_group: {{ ci_job_resource_group }}
  script:
    - pip install ansible-core==2.13.1
    # ansible-test needs special directory structure.
    - mkdir -p /work-dir/ansible_collections/scale_computing/
    - cp -a ./  /work-dir/ansible_collections/scale_computing/hypercore
    - pushd /work-dir/ansible_collections/scale_computing/hypercore
    #
    - |
      cat <<EOF >tests/integration/integration_config.yml
      # Generated by .gitlab-ci.yml
      sc_host: ${SC_HOST}
      sc_username: ${SC_USERNAME}
      sc_password: ${SC_PASSWORD}
      smb_server: ${SMB_SERVER}
      smb_share: ${SMB_SHARE}
      smb_username: ${SMB_USERNAME}
      smb_password: ${SMB_PASSWORD}
      EOF
    - cat tests/integration/integration_config.yml
    - ansible-test integration {{ integration_test_name }}
# --------------------------------------------------------------


