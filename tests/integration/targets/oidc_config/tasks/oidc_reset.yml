---
# Reset OIDC values in the webUI

- name: Wait N sec - Cluster needs to finish login
  ansible.builtin.pause:
    seconds: 15

- name: Get current oidc values
  scale_computing.hypercore.api:
    action: get
    endpoint: /rest/v1/OIDCConfig
  register: oidc_config_result
- name: Show current OIDC
  ansible.builtin.debug:
    var: oidc_config_result

- ansible.builtin.debug:
    var: oidc_config_result

- name: Replace current OIDC values
  scale_computing.hypercore.api:
    action: patch
    endpoint: /rest/v1/OIDCConfig/oidcconfig_uuid
    data:
      clientID: "{{ oidc_config.client_id_default }}"
      sharedSecret: "{{ oidc_config.shared_secret_default }}"
      configurationURL: "{{ oidc_config.config_url_default }}"
      scopes: "{{ oidc_config.scopes }}"
  # Frequently we get HTML document with "502 Bad Gateway" message,
  # instead of normal json response (with taskTag etc).
  # If this happens, just retry after short delay.
  register: api_oidc_result
  retries: 5
  delay: 5
  until: api_oidc_result is succeeded

- name: Wait N sec - Cluster needs to finish login
  ansible.builtin.pause:
    seconds: 15
