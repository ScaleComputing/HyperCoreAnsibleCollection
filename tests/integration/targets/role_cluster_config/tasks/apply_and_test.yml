---
# input: cluster_config_applied, cluster_config_expected

- name: Apply cluster_config - {{ dbg_suffix }}
  include_role:
    name: scale_computing.hypercore.cluster_config
  vars:
    scale_computing_hypercore_cluster_config: "{{ cluster_config_applied }}"

# check config is applied, for each setting
- name: Retrieve cluster_info - {{ dbg_suffix }}
  scale_computing.hypercore.cluster_info:
  register: cluster_info_result

- name: Retrieve registration_info - {{ dbg_suffix }}
  scale_computing.hypercore.registration_info:
  register: registration_info_result

- name: Retrieve DNS config - {{ dbg_suffix }}
  scale_computing.hypercore.dns_config_info:
  register: dns_config_info_result

- name: Retrieve OIDC config - {{ dbg_suffix }}
  scale_computing.hypercore.oidc_config_info:
  register: oidc_config_info_result

- name: Retrieve time_server - {{ dbg_suffix }}
  scale_computing.hypercore.time_server_info:
  register: time_server_info_result

- name: Check state - {{ dbg_suffix }}
  ansible.builtin.assert:
    that:
      - cluster_info_result.record.name == cluster_config_expected.name
      - registration_info_result.record.company_name == cluster_config_expected.registration.company_name
      - registration_info_result.record.contact == cluster_config_expected.registration.contact
      - registration_info_result.record.email == cluster_config_expected.registration.email
      - registration_info_result.record.phone == cluster_config_expected.registration.phone
      - dns_config_info_result.record.server_ips == cluster_config_expected.dns.server_ips
      - dns_config_info_result.record.search_domains == cluster_config_expected.dns.search_domains
      - oidc_config_info_result.record.client_id == cluster_config_expected.oidc.client_id
      - oidc_config_info_result.record.config_url == cluster_config_expected.oidc.config_url
      - oidc_config_info_result.record.scopes == cluster_config_expected.oidc.scopes
      - time_server_info_result.record.host == cluster_config_expected.time_server
